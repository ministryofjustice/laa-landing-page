# LAA Portal Landing Page

[![repo standards badge](https://img.shields.io/endpoint?labelColor=231f20&color=005ea5&style=for-the-badge&label=MoJ%20Compliant&url=https%3A%2F%2Foperations-engineering-reports.cloud-platform.service.justice.gov.uk%2Fapi%2Fv1%2Fcompliant_public_repositories%2Fendpoint%2Ftemplate-repository&logo=data:image/png;base64,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)](https://operations-engineering-reports.cloud-platform.service.justice.gov.uk/public-report/template-repository)

## Introduction

The LAA Portal Landing Page is a user facing application for the LAA.
It controls authentication and authorisation to most LAA web applications.
Users of the Portal include both internal LAA staff and external solicitors (providers of legal aid).
This is a prototype application developed and maintained by the LAA portal stabilisation dev team.

## Running the app locally

### Prerequisites

#### Install Java

Ensure you have installed the correct version of Java on your local machine. At the time of writing this is Java 21.
Some MoJ devices will come prepackaged with the latest version of Java

Check your local version of Java: `java -version`

To check all versions of Java you have installed locally run: `/usr/libexec/java_home -V`

Once you have downloaded Java, you can open your bash profile:

```
sudo nano ~/.bash_profile
```

enter your device password add export the version of Java you wish to use:

```
export JAVA_HOME=$(/usr/libexec/java_home -v 21.0.7)
```

Once exported be sure to source your latest bash profile: `source ~/.bash_profile   `

#### Obtaining an Entra user

- You need a valid **MoJ DEVL External email address** for Entra ID authentication. This email will be used for validation.
  - If you do not have one, reach out to an Entra admin in the #laa-portal-stabilisation-tech Slack channel.

#### Obtaining Client Credentials

- The client secret and client ID are available in the Entra UI:
  - Path: App registrations > laa-portal-oidc-playground > Certificates & secrets.

- If you do not have the necessary permissions to view the client ID and secret, request them from an Entra admin.

#### Creating a GitHub Token

1. Ensure you have created a classic GitHub Personal Access Token with the following permissions:
   1. repo
   2. write:packages
   3. read:packages
2. The token **must be authorised with (MoJ) SSO**.
3. Add the following parameters to `~/.gradle/gradle.properties`

```
project.ext.gitPackageUser = <your GitHub username>
project.ext.gitPackageKey = <your GitHub access token>
```

For more detailed instructions, refer to the laa-ccms-spring-boot-common repository [here](https://github.com/ministryofjustice/laa-ccms-spring-boot-common?tab=readme-ov-file).

More information on GDS can be found [here](https://gds-way.digital.cabinet-office.gov.uk/).

#### Enable Pre-commit Hooks

Secret scanning is run on pre-commit hooks to prevent secrets being committed to the repository, via Gitleaks, TruffleHog and GitGuardian Shield. These are enabled via the [pre-commit](https://pre-commit.com/) framework, configured via [.pre-commit-config.yaml](./.pre-commit-config.yaml).

The pre-commit hooks will only be enabled for this repository, and won't affect others. The secret scanner CLI utilities themselves - `gitleaks`, `trufflehog` & `ggshield` - will be available in your shells to be ran against anything you wish.

To enable the pre-commit hooks:
1. Download and install [Homebrew](https://github.com/Homebrew/brew/releases/latest)
2. Authorise GitGuardian with your Ministry of Justice GitHub user account [here](https://dashboard.gitguardian.com/api/v1/auth/user/github_login/authorize) (you only have to link your account, you do not need to go on to grant GitGuardian access to any personal or MoJ repository in this step as it shouldn't be necessary for running GitGuardian Shield locally)
3. Run the setup script (will take a few minutes to complete the first time it is ran):

```sh
./setup_precommits.sh
```

4. Acquire a GitGuardian Shield personal access token (will open authorisation in your browser), this is used to allow `ggshield` access to GitGuardian's API for scanning, and only needs to be performed once on your local machine:

```sh
ggshield auth login
```

The pre-commit hooks will now run as and when you commit your changes.

To run the pre-commit secret scanners on everything in the repository:

```sh
pre-commit run --all-files
```

The hooks and dependencies can be updated by running the `setup_precommits.sh` script whenever needed (there is also an updater for the hooks alone that automatically runs on each pre-commit).

#### Obtaining a Dockerhub account

In order to run a database locally, you must have a licensed Docker account - please reach to the team to set this up.

#### Obtaining a GOV.UK Notify API Key

- You need a valid **GOV.UK Notify API Key** for GOV.UK Notify authentication.
  - If you do not have one, reach out to an Entra admin in the #laa-portal-stabilisation-tech Slack channel.

#### Obtaining a Sentry.IO API Key

- Ensure you have signed up for Sentry using the [SSO link](https://sentry.io/auth/login/ministryofjustice/).
- If you are not part of the Portal Stabilisation Sentry team - ask internally to be added.
- A token can be generated [here](https://ministryofjustice.sentry.io/settings/auth-tokens/new-token/).

#### Filling out .env

Using the `.env-template` file as a template, copy to a new .env file
`cp .env-template .env`

Be sure to fill out all values as they are required for pulling dependencies for the application to run

### Running the Application

Ensure that all environment variables from `.env` set

```sh
set -o allexport
source <(grep -v '^#' .env | grep -v '^\s*$') 2>/dev/null
set +o allexport
```

> You may see errors from this command - it should still work, verify the variables are being exported with `env`

Once the environment variables are set, you can run must first start the database:

#### Starting the Database

1. Ensure Docker is installed, running & you are signed in with a **licensed** Docker account (see prerequisites above).
2. Navigate to the root of the repository
3. Using the Terminal, run `docker-compose up -d` - this will start the database container using Docker.

**The script `db-tool.sh` includes various functions to assist in local development**

#### Generating DB Changelog

If there are changes made to DB structure

1. Ensure there are two DB instances running one with existing version and another with new DB changes
2. Issue the command below to generate the changelog (it requires installing liquibase locally using brew)
```
liquibase diff-changelog --changelog-file=diff-changelog.yml --url="jdbc:postgresql://localhost:5432/portal-database" --username=<<uname>> --password=<<pwd>>
--reference-url="jdbc:postgresql://localhost:54321/portal-database" --reference-username=<<uname>> --reference-password=<<pwd>>
```
3. Copy the diff-changelog.yml file to application resources folder (*resources/db/changelog/changesets/*) and rename it to `db.changesets-<<next_version>>.yaml`
4. Ensure custom constraints are retained along with any new constraints

*Please note liquibase does not generate partial indexes or some custom constraints. Please ensure the constraints are add to the changelog file at the bottom of the file.*



#### Starting the Application

- **IntelliJ IDEA:**
  1. Open the project in IntelliJ.
  2. Open the Gradle tool window (`View > Tool Windows > Gradle`).
  3. Configure the run configuration for the `bootRun` task with required environment variables
  <br/>(Refer to the `Glossary of Environment Variables` section below for the details on what each envi field contains).
  3. Navigate to `Tasks > application` and double-click `bootRun`.

- **VSCode:**
  1. Open the project in VSCode
  2. Open a VSCode Terminal
  3. Ensure the `.env` environment variables are exported inside the terminal
  <br/>(Refer to the `Glossary of Environment Variables` section below for the details on what each envi field contains)
  4. Run the following command:
     ```sh
     ./gradlew bootRun
     ```

- **Command Line:**
  1. Navigate to the project root directory.
  2. Run the following command:
     ```sh
     ./gradlew bootRun
     ```

Once the application is running steadily, you can access the UI by navigating to:

```
http://localhost:8080
```

### Snyk & Trivy Integration

If a pipeline is picking up a vulnerability that you wish to add to the ignore list, then make sure to add it to either `.trivyignore` or `.snyk` rather than resolving in the UI.

## Automation Playwright Test Suite

**These tests are used for automation testing of LAA Landing Page using Playwright with Java**

### Location:

     src/playwrightTest

### Configuration:

    src/playwrightTest/resources/playwright.properties

### Running Tests

- Update url, username and password in configuration file
- Run individual tests, classes or test suits.
- Tests can run in headless or headed mode
  - This can be configured using headless property in configuration file

### Tests Coverage

- UI of LAA Landing Page
- Reusable logic e.g. login will be in BaseFrontEndTest class

### Glossary of Environment Variables

<details>
<summary>Environment Variables</summary>

| Environment Variable                | Description                                                                                                                                                          |
|-------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| APP_CCMS_ACCOUNT_LINK_DETAILS       | Details of `CCMS Account Linking` Application. The value should be in the form of app_entra_oid//app_security_group_name//app_security_group_id                      |
| APP_CCMS_ACCOUNT_LINK_NAME          | Name of `CCMS Account Linking` Application                                                                                                                           |
| APP_CCMS_ACCOUNT_LINK_URL           | URL of `CCMS Account Linking` Application                                                                                                                            |
| APP_CIVIL_APPLY_DETAILS             | Details of `Civil Legal Aid` Application. The value should be in the form of app_name//app_entra_oid//app_security_group_name//app_security_group_id                 |
| APP_CIVIL_APPLY_NAME                | Name of `Civil Legal Aid` Application                                                                                                                                |
| APP_CIVIL_APPLY_URL                 | URL of `Civil Legal Aid` Application                                                                                                                                 |
| APP_CRIME_APPLY_DETAILS             | Details of `Criminal Legal Aid` Application. The value should be in the form of app_name//app_entra_oid//app_security_group_name//app_security_group_id              |
| APP_CRIME_APPLY_NAME                | Name of `Criminal Legal Aid` Application                                                                                                                             |
| APP_CRIME_APPLY_URL                 | URL of `Criminal Legal Aid` Application                                                                                                                              |
| APP_PUI_DETAILS                     | Details of `CCMS` Application. The value should be in the form of app_name//app_entra_oid//app_security_group_name//app_security_group_id                            |
| APP_PUI_NAME                        | Name of `CCMS` Application                                                                                                                                           |
| APP_PUI_URL                         | URL of `CCMS` Application                                                                                                                                            |
| APP_SUBMIT_CRIME_FORM_DETAILS       | Details of `Submit Crime Form` Application. The value should be in the form of app_name//app_entra_oid//app_security_group_name//app_security_group_id               |
| APP_SUBMIT_CRIME_FORM_NAME          | Name of `Submit Crime Form` Application                                                                                                                              |
| APP_SUBMIT_CRIME_FORM_URL           | URL of `Submit Crime Form` Application                                                                                                                               |
| APP_SUBMIT_A_BULK_CLAIM_DETAILS     | Details of `Submit A Bulk Claim` Application. The value should be in the form of app_name//app_entra_oid//app_security_group_name//app_security_group_id             |
| APP_SUBMIT_A_BULK_CLAIM_NAME        | Name of `Submit A Bulk Claim` Application                                                                                                                            |
| APP_SUBMIT_A_BULK_CLAIM_URL         | URL of `Submit A Bulk Claim` Application                                                                                                                             |
| APP_DEFAULT_USER_ACC_SEC_GROUP      | Name of the default security group (provided by Tech Services)                                                                                                       |
| APP_CIVIL_CLAIM_FOR_PAYMENT_DETAILS | Details of `Civil Claim for Payment` Application. The value should be in the form of app_name//app_entra_oid//app_security_group_name//app_security_group_id         |
| APP_CIVIL_CLAIM_FOR_PAYMENT_NAME    | Name OF `Civil Claim for Payment` Application                                                                                                                        |
| APP_CIVIL_CLAIM_FOR_PAYMENT_URL     | URL OF `Civil Claim for Payment` Application                                                                                                                         |
| DISTRIBUTED_DB_LOCKING_PERIOD       | Number minutes to lock the distributed DB row for each key                                                                                                           |
| ENABLE_DISTRIBUTED_DB_LOCKING       | Enable or distributed DB row locking (true/false). Setting the flag to false will let all the nodes run the process. True will let only one node to run the process  |
| FIRM_CACHE_CLEAR_SCHEDULE           | The cron value to define how often the firms cache should be cleared.                                                                                                |
| APPS_CACHE_CLEAR_SCHEDULE           | The cron value to define how often the apps cache should be cleared.                                                                                                 | 
| POLLING_ENABLED                     | true/false. Setting the flag to true will sync the internal users. Enable ENABLE_DISTRIBUTED_DB_LOCKING to avoid duplicate run by nodes.                             |
| POLLING_INTERVAL                    | How often the internal users should be synced. The value is set in milliseconds.                                                                                     |
| POPULATE_DUMMY_DATA                 | true/flase to control if the test data should be populated.                                                                                                          |
| SENTRY_ENABLED                      |                                                                                                                                                                      |
| TECH_SERVICES_AZURE_SCOPE           | The Azure scope needed to do App Security group sync when roles assigned.                                                                                            |
| TECH_SERVICES_CLEAR_CACHE_INTERVAL  | How often the token is kept in cache. Value specified in milliseconds.                                                                                               |                                                                                                    |
| TECH_SERVICES_LAA_BUSINESS_UNIT     | The business unit to use for making tech services call.                                                                                                              |
| TECH_SERVICES_REQ_CONNECT_TIMEOUT   | The connection timeout configured while doing Tech services api calls. The value is set in seconds.                                                                  |
| TECH_SERVICES_REQ_READ_TIMEOUT      | The request timeout configured while doing Tech services api calls. The value is set in seconds.                                                                     |
| TECH_SERVICES_VERIFICATION_METHOD   | The value to specify how the external user gets verified (by email/by post)                                                                                          |
| POLLING_GROUP_ID                    |                                                                                                                                                                      |
| TECH_SERVICES_AZURE_CLIENT_ID       | Azure client id required to acquire Tech Services token.                                                                                                             |
| TECH_SERVICES_AZURE_CLIENT_SECRET   | Azure client secret required to acquire Tech Services token.                                                                                                         |
| TECH_SERVICES_BASE_URL              | Tech Services api base url                                                                                                                                           |
| TECH_SERVICES_TENANT_ID             | Azure Tenant Id required to acquire Tech Services token.                                                                                                             |
| TEST_DATA_ADMIN_PRINCIPALS          | The user list to be loaded as admin users for testing using test data population (The values should be in the format of email:entra_id, comma separated)             |
| TEST_DATA_INTERNAL_PRINCIPALS       | The user list to be loaded as internal users for testing using test data population (The values should be in the format of email:entra_id, comma separated)          |
| TEST_DATA_NON_ADMIN_PRINCIPALS      | The user list to be loaded as standard external users for testing using test data population (The values should be in the format of email:entra_id, comma separated) |
| FEATURE_FLAG_ENABLE_RESEND_VER_CODE | Flag to define if resend verification code is enabled or not                                                                                                         |
| SPRING_SESSION_JDBC_ENABLED         | Enable or Disable storing of http session in db                                                                                                                      |

</details>
