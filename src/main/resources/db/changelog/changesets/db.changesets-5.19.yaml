databaseChangeLog:
  - changeSet:
      id: add-firm-enabled-column-20260209-1
      author: paul.snowdon
      comment: Add enabled column to firm table to support soft disable for PDA contract gaps
      preConditions:
        - onFail: MARK_RAN
        - not:
            - columnExists:
                tableName: firm
                columnName: enabled
      changes:
        - sql:
            dbms: postgresql
            comment: Add enabled column with default true for existing firms
            sql: "ALTER TABLE firm ADD COLUMN enabled BOOLEAN NOT NULL DEFAULT true;"
        - sql:
            dbms: postgresql
            splitStatements: false
            comment: Update check_firms_have_office function to allow disabled firms without offices
            sql: "CREATE OR REPLACE FUNCTION check_firms_have_office() 
                RETURNS trigger LANGUAGE plpgsql AS $$ 
                BEGIN 
                  IF EXISTS ( 
                    SELECT 1 
                    FROM firm f 
                    WHERE f.enabled = true 
                    AND NOT EXISTS ( 
                      SELECT 1 FROM office o 
                      WHERE o.firm_id = f.id 
                    ) 
                  ) THEN 
                    RAISE EXCEPTION 'Enabled firm must have at least one office'; 
                  END IF; 
                  IF TG_OP = 'DELETE' THEN 
                    RETURN OLD; 
                  ELSE 
                    RETURN NEW; 
                  END IF; 
                END; 
                $$"
      rollback:
        - sql:
            dbms: postgresql
            splitStatements: false
            comment: Restore original check_firms_have_office function
            sql: "CREATE OR REPLACE FUNCTION check_firms_have_office() 
                RETURNS trigger LANGUAGE plpgsql AS $$ 
                BEGIN 
                  IF EXISTS ( 
                    SELECT 1 
                    FROM firm f 
                    WHERE NOT EXISTS ( 
                      SELECT 1 FROM office o 
                      WHERE o.firm_id = f.id 
                    ) 
                  ) THEN 
                    RAISE EXCEPTION 'Firm must have at least one office'; 
                  END IF; 
                  IF TG_OP = 'DELETE' THEN 
                    RETURN OLD; 
                  ELSE 
                    RETURN NEW; 
                  END IF; 
                END; 
                $$"
        - sql:
            dbms: postgresql
            sql: "ALTER TABLE firm DROP COLUMN IF EXISTS enabled;"
