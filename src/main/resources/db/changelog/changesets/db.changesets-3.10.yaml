databaseChangeLog:
  - changeSet:
      id: 759998901000-1
      author: pijian.liao
      changes:
        # update table firm, add field parent_firm_id, add constraint
        - addColumn:
            columns:
              - column:
                  name: parent_firm_id
                  type: UUID
            tableName: firm
        - addForeignKeyConstraint:
            baseColumnNames: parent_firm_id
            baseTableName: firm
            constraintName: FK_parent_firm_firm_id
            deferrable: false
            initiallyDeferred: false
            onDelete: NO ACTION
            onUpdate: NO ACTION
            referencedColumnNames: id
            referencedTableName: firm
            validate: true
        # create function is_child
        - sql:
            dbms: postgresql
            sql: "CREATE FUNCTION is_child(uuid) RETURNS boolean AS '
                      SELECT EXISTS(SELECT 1 from firm where id = $1 and parent_firm_id is not null);
                  ' LANGUAGE SQL;"
        # constraint no grandparent
        - sql:
            dbms: postgresql
            sql: "alter table firm add constraint no_grandparent check (not is_child(parent_firm_id) or parent_firm_id is null)"
        # constraint no self parent
        - sql:
            dbms: postgresql
            sql: "alter table firm add constraint self_parent check (parent_firm_id != id)"