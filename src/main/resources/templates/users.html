<!DOCTYPE html>
<html lang="en" th:replace="~{layout :: layout(
      title=~{::title},
      mainContent=~{::#main-content},
      pageCategory=${'users'})}" xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Users</title>
</head>

<body>
<main class="govuk-main-wrapper" id="main-content" th:if="${#authentication.isAuthenticated()}">
    <div th:if="${successMessage}" role="region" class="moj-alert moj-alert--success moj-alert--with-heading"
         aria-label="success: User added successfully" data-module="moj-alert">
        <div>
            <svg class="moj-alert__icon" role="presentation" focusable="false" xmlns="http://www.w3.org/2000/svg"
                 viewBox="0 0 30 30" height="30" width="30">
                <path
                        d="M11.2869 24.6726L2.00415 15.3899L4.62189 12.7722L11.2869 19.4186L25.3781 5.32739L27.9958 7.96369L11.2869 24.6726Z"
                        fill="currentColor" />
            </svg>
        </div>
    </div>
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-full">
            <div class="moj-page-header-actions">
                <div class="moj-page-header-actions__title">
                    <h1 class="govuk-heading-l">Manage your users</h1>
                </div>
                <form class="form" method="post" action="" th:if="${allowCreateUser}">
                    <div class="moj-page-header-actions__actions">
                        <div class="moj-button-group moj-button-group--inline">
                            <button type="button" class="govuk-button govuk-button--secondary"
                                    data-module="govuk-button" data-govuk-button-init=""
                                    onclick="location.href='/admin/user/create/details';">
                                Create a new user
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <div class="govuk-grid-row">
                <div class="govuk-grid-column-one-half">
                    <form method="get" th:action="@{/admin/users}" role="search" id="search-form" th:object="${firmSearchForm}">
                        <div class="govuk-grid-row">
                            <div class="moj-search">
                                <div class="govuk-form-group">
                                    <label class="govuk-label govuk-label--m moj-search__label govuk-!-font-weight-bold"
                                           for="search">
                                        Search users by name or email

                                    </label>
                                    <input class="govuk-input govuk-!-width-full" id="search" name="search"
                                           type="search" th:value="${param.search}" autocomplete="off">
                                </div>
                                <button type="submit" class="govuk-button moj-search__button"
                                        data-module="govuk-button">
                                    Search
                                </button>
                            </div>
                        </div>

                        <!-- Firm selection -->
                        <div class="govuk-grid-row">
                            <div class="govuk-form-group">
                                <label class="govuk-label govuk-label--m govuk-!-font-weight-bold" for="firmSearch">
                                    Filter by firm
                                    <span class="govuk-hint" id="firm-hint">
                        Start typing to search for a firm
                    </span>
                                </label>
                                <div class="autocomplete__wrapper">
                                    <div class="autocomplete__status" aria-live="polite" role="status">
                                        <span id="firmSearch__status--A" class="govuk-visually-hidden"></span>
                                        <span id="firmSearch__status--B" class="govuk-visually-hidden"></span>
                                    </div>
                                    <div style="position: relative; display: inline-block; width: 100%;">
                                        <input class="autocomplete__input govuk-input"
                                               id="firmSearch"
                                               name="firmSearch"
                                               type="text"
                                               autocomplete="off"
                                               aria-autocomplete="list"
                                               aria-expanded="false"
                                               aria-controls="firmSearch__listbox"
                                               aria-describedby="firm-hint"
                                               aria-owns="firmSearch__listbox"
                                               role="combobox"
                                               th:value="${firmSearchForm?.firmSearch}">
                                        <input type="hidden" name="firmSearchForm.selectedFirmId" id="selectedFirmId" th:value="${firmSearchForm?.selectedFirmId}" />
                                        <input type="hidden" name="firmId" id="firmId" th:value="${firmSearchForm?.selectedFirmId}" />
                                        <div id="firmSearch__assistiveHint" class="govuk-hint govuk-visually-hidden"
                                             role="status">
                                            When autocomplete results are available, use up and down arrows to
                                            review and enter to select.
                                            Touch device users, explore by touch or with swipe gestures.
                                        </div>
                                        <ul id="firmSearch__listbox"
                                            class="autocomplete__menu autocomplete__menu--hidden"
                                            role="listbox"
                                            aria-label="Firm search results">
                                            <!-- Search results will be populated here via JavaScript -->
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Firm admin choice box -->
                        <div class="govuk-grid-row">
                            <div class="govuk-form-group govuk-!-margin-top-3">
                                <fieldset class="govuk-fieldset">
                                    <div class="govuk-checkboxes govuk-checkboxes--small"
                                         data-module="govuk-checkboxes">
                                        <div class="govuk-checkboxes__item">
                                            <input class="govuk-checkboxes__input" id="show-firm-admins"
                                                   name="showFirmAdmins"
                                                   type="checkbox" value="true"
                                                   onchange="this.form.submit();"
                                                   th:checked="${param.showFirmAdmins != null && param.showFirmAdmins[0] == 'true'}">
                                            <label class="govuk-label govuk-checkboxes__label" for="organisation">
                                                Show firm admins
                                            </label>
                                        </div>
                                    </div>
                                </fieldset>
                            </div>
                        </div>

                    </form>
                </div>
            </div>

            <style>
                /* Style the autocomplete to look like a GOV.UK select dropdown */
                .autocomplete__wrapper {
                    position: relative;
                }

                .autocomplete__menu {
                    background-color: #ffffff;
                    border: 2px solid #0b0c0c;
                    border-top: none;
                    box-sizing: border-box;
                    color: #0b0c0c;
                    font-family: "GDS Transport", arial, sans-serif;
                    font-size: 19px;
                    font-weight: 400;
                    line-height: 1.31579;
                    margin: 0;
                    max-height: 200px;
                    overflow-y: auto;
                    padding: 0;
                    position: absolute;
                    top: 100%;
                    left: 0;
                    width: 100%;
                    z-index: 100;
                    list-style: none;
                    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
                }

                .autocomplete__menu--hidden {
                    display: none !important;
                }

                .autocomplete__menu--inline {
                    display: block;
                }

                .autocomplete__option {
                    background-color: #ffffff;
                    border-bottom: 1px solid #b1b4b6;
                    color: #0b0c0c;
                    cursor: pointer;
                    display: block;
                    font-size: 19px;
                    line-height: 1.31579;
                    padding: 8px 12px;
                    text-decoration: none;
                    position: relative;
                }

                .autocomplete__option:last-child {
                    border-bottom: none;
                }

                .autocomplete__option:hover,
                .autocomplete__option[aria-selected="true"] {
                    background-color: #1d70b8;
                    color: #ffffff;
                }

                .autocomplete__option:hover strong,
                .autocomplete__option[aria-selected="true"] strong {
                    color: #ffffff;
                }

                .autocomplete__option:hover small,
                .autocomplete__option[aria-selected="true"] small {
                    color: #ffffff !important;
                }

                .autocomplete__option strong {
                    font-weight: 600;
                    display: block;
                    margin-bottom: 2px;
                }

                .autocomplete__option small {
                    font-size: 16px;
                    color: #505a5f;
                    display: block;
                }

                /* Make the input look consistent with GOV.UK select styling */
                .autocomplete__input {
                    -webkit-appearance: none;
                    -moz-appearance: none;
                    appearance: none;
                    background-color: #ffffff;
                    border: 2px solid #0b0c0c;
                    border-radius: 0;
                    box-sizing: border-box;
                    color: #0b0c0c;
                    font-family: "GDS Transport", arial, sans-serif;
                    font-size: 19px;
                    font-weight: 400;
                    line-height: 1.31579;
                    margin: 0;
                    padding: 5px 4px 4px;
                    width: 100%;
                }

                .autocomplete__input:focus {
                    border-color: #fd0;
                    box-shadow: inset 0 0 0 2px;
                    outline: 3px solid #fd0;
                    outline-offset: 0;
                }

                /* Remove the odd styling to make it more uniform like a select */
                .autocomplete__option--odd {
                    background-color: #ffffff;
                }

                .autocomplete__option--odd:hover,
                .autocomplete__option--odd[aria-selected="true"] {
                    background-color: #1d70b8;
                    color: #ffffff;
                }
            </style>

            <script>

                document.addEventListener('DOMContentLoaded', function () {
                    const firmSearchInput = document.getElementById('firmSearch');
                    const firmSearchListbox = document.getElementById('firmSearch__listbox');
                    const selectedFirmIdInput = document.getElementById('selectedFirmId');
                    const statusA = document.getElementById('firmSearch__status--A');
                    const statusB = document.getElementById('firmSearch__status--B');
                    const assistiveHint = document.getElementById('firmSearch__assistiveHint');


                    if (!firmSearchInput) {
                        // If the input is not found, return early
                        return;
                    }

                    let searchTimeout;
                    let selectedIndex = -1;
                    let currentStatusElement = statusA;

                    // Show assistive hint when input is focused
                    firmSearchInput.addEventListener('focus', function () {
                        assistiveHint.style.display = 'block';
                    });

                    // Handle input changes
                    firmSearchInput.addEventListener('input', function () {
                        clearTimeout(searchTimeout);
                        const query = this.value.trim();

                        // If the input is empty, hide results and reset selected firm ID
                        if (query.length < 3) {
                            hideResults();
                            selectedFirmIdInput.value = '';
                            return;
                        }

                        // Debounce search requests
                        searchTimeout = setTimeout(() => {
                            searchFirms(query);
                        }, 300);
                    });

                    // Handle keyboard navigation
                    firmSearchInput.addEventListener('keydown', function (e) {
                        const items = firmSearchListbox.querySelectorAll('.autocomplete__option');

                        if (e.key === 'ArrowDown') {
                            e.preventDefault();
                            selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                            updateSelection(items);
                            updateStatus(`${selectedIndex + 1} of ${items.length}`);
                        } else if (e.key === 'ArrowUp') {
                            e.preventDefault();
                            selectedIndex = Math.max(selectedIndex - 1, -1);
                            updateSelection(items);
                            if (selectedIndex >= 0) {
                                updateStatus(`${selectedIndex + 1} of ${items.length}`);
                            }
                        } else if (e.key === 'Enter' && selectedIndex >= 0) {
                            e.preventDefault();
                            items[selectedIndex].click();
                        } else if (e.key === 'Escape') {
                            hideResults();
                        }
                    });

                    // Hide results when clicking outside
                    document.addEventListener('click', function (e) {
                        if (!firmSearchInput.contains(e.target) && !firmSearchListbox.contains(e.target)) {
                            hideResults();
                        }
                    });

                    function searchFirms(query) {
                        updateStatus('Searching...');
                        fetch(`/admin/user/firms/search?q=${encodeURIComponent(query)}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                        })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(data => {
                                displayResults(data);
                            })
                            .catch(error => {
                                hideResults();
                                updateStatus('Search failed: ' + error.message);
                            });
                    }

                    function displayResults(firms) {
                        firmSearchListbox.innerHTML = '';
                        selectedIndex = -1;

                        // Check if we have a search query
                        const currentQuery = firmSearchInput.value.trim();

                        if (firms.length === 0 && currentQuery.length > 0) {
                            // Only show "No firms found" if there's a search query but no results
                            const noResultsItem = document.createElement('li');
                            noResultsItem.className = 'autocomplete__option';
                            noResultsItem.textContent = 'No firms found';
                            noResultsItem.setAttribute('role', 'option');
                            noResultsItem.setAttribute('aria-selected', 'false');
                            noResultsItem.style.color = '#6f777b';
                            firmSearchListbox.appendChild(noResultsItem);

                            showResults();
                            updateStatus('No results found');
                            return;
                        } else if (firms.length === 0) {
                            // If no search query, just hide results
                            hideResults();
                            return;
                        }

                        firms.forEach((firm, index) => {
                            const item = document.createElement('li');
                            item.className = 'autocomplete__option';
                            item.setAttribute('aria-selected', 'false');
                            item.setAttribute('role', 'option');
                            item.setAttribute('tabindex', '-1');
                            item.setAttribute('id', `firmSearch__option--${index}`);
                            item.setAttribute('aria-posinset', index + 1);
                            item.setAttribute('aria-setsize', firms.length);

                            // Create a more select-like display format - using safe DOM manipulation
                            const firmName = firm.name || '';
                            const firmCode = firm.code && firm.code.trim() ? firm.code : 'No code available';

                            // Create elements safely to prevent XSS
                            const strongElement = document.createElement('strong');
                            strongElement.textContent = firmName;

                            const smallElement = document.createElement('small');
                            smallElement.textContent = `Firm code: ${firmCode}`;

                            item.appendChild(strongElement);
                            item.appendChild(smallElement);

                            item.addEventListener('click', function () {
                                selectFirm(firm);
                            });

                            item.addEventListener('mouseenter', function () {
                                selectedIndex = index;
                                updateSelection(firmSearchListbox.querySelectorAll('.autocomplete__option'));
                            });

                            firmSearchListbox.appendChild(item);
                        });

                        showResults();
                        updateStatus(`${firms.length} result${firms.length === 1 ? '' : 's'} available`);
                    }

                    function selectFirm(firm) {
                        firmSearchInput.value = firm.name;
                        selectedFirmIdInput.value = firm.id;
                        hideResults();
                        updateStatus(`${firm.name} selected`);
                    }

                    function updateSelection(items) {
                        items.forEach((item, index) => {
                            // Add null check to prevent errors
                            if (!item) return;

                            if (index === selectedIndex) {
                                item.setAttribute('aria-selected', 'true');
                                item.style.backgroundColor = '#1d70b8';
                                item.style.color = 'white';

                                // Scroll into view if needed
                                item.scrollIntoView({block: 'nearest'});
                            } else {
                                item.setAttribute('aria-selected', 'false');
                                item.style.backgroundColor = '';
                                item.style.color = '';
                            }
                        });
                    }

                    function showResults() {
                        firmSearchListbox.classList.remove('autocomplete__menu--hidden');
                        firmSearchListbox.classList.add('autocomplete__menu--inline');
                        firmSearchInput.setAttribute('aria-expanded', 'true');
                    }

                    function hideResults() {
                        firmSearchListbox.classList.add('autocomplete__menu--hidden');
                        firmSearchListbox.classList.remove('autocomplete__menu--inline');
                        firmSearchInput.setAttribute('aria-expanded', 'false');
                        selectedIndex = -1;
                        if (assistiveHint) {
                            assistiveHint.style.display = 'none';
                        }
                    }

                    function updateStatus(message) {
                        // Alternate between status elements for better screen reader support
                        currentStatusElement = currentStatusElement === statusA ? statusB : statusA;
                        currentStatusElement.textContent = message;
                    }
                });
            </script>
        </div>
    </div>


    <form class="govuk-form-group govuk-!-margin-top-3">
        <div class="table-container" style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
            <table class="govuk-table" data-id-prefix="users-"
                   style="table-layout: fixed; min-width: 768px; width: 100%;">
                <thead class="govuk-table__head">
                <tr class="govuk-table__row">
                    <th scope="col" class="govuk-table__header"
                        th:aria-sort="${sort == 'firstName' ? direction : 'none'}" style="width: 20%; min-width: 120px;">
                        <button type="button" data-index="0"
                                th:onclick="'window.location.href=\'' + @{/admin/users(size=${requestedPageSize ?: 10}, page=${page ?: 1}, search=${search}, sort='firstName', direction=${sort == 'firstName' and direction == 'asc' ? 'desc' : 'asc'}, usertype=${usertype}, showFirmAdmins=${showFirmAdmins})} + '\''">
                            Name
                            <img th:if="${sort == 'firstName' and direction == 'asc'}"
                                 th:src="@{/assets/images/sort-asc.svg}"
                                 width="22" height="22" alt="">
                            <img th:if="${sort == 'firstName' and direction == 'desc'}"
                                 th:src="@{/assets/images/sort-desc.svg}"
                                 width="22" height="22" alt="">
                            <img th:if="${sort != 'firstName'}"
                                 th:src="@{/assets/images/sort-none.svg}"
                                 width="22" height="22" alt="">
                        </button>
                    </th>
                    <th scope="col" class="govuk-table__header"
                        th:aria-sort="${sort == 'firmName' ? direction : 'none'}" style="width: 20%; min-width: 120px;">
                        <button type="button" data-index="1"
                                th:onclick="'window.location.href=\'' + @{/admin/users(size=${requestedPageSize ?: 10}, page=${page ?: 1}, search=${search}, sort='firmName', direction=${sort == 'firmName' and direction == 'asc' ? 'desc' : 'asc'}, usertype=${usertype}, showFirmAdmins=${showFirmAdmins})} + '\''">
                            Firm
                            <img th:if="${sort == 'firmName' and direction == 'asc'}"
                                 th:src="@{/assets/images/sort-asc.svg}"
                                 width="22" height="22" alt="">
                            <img th:if="${sort == 'firmName' and direction == 'desc'}"
                                 th:src="@{/assets/images/sort-desc.svg}"
                                 width="22" height="22" alt="">
                            <img th:if="${sort != 'firmName'}"
                                 th:src="@{/assets/images/sort-none.svg}"
                                 width="22" height="22" alt="">
                        </button>
                    </th>
                    <th scope="col" class="govuk-table__header"
                        th:aria-sort="${sort == 'email' ? direction : 'none'}" style="width: 35%; min-width: 200px;">
                        <button type="button" data-index="2"
                                th:onclick="'window.location.href=\'' + @{/admin/users(size=${requestedPageSize ?: 10}, page=${page ?: 1}, search=${search}, sort='email', direction=${sort == 'email' and direction == 'asc' ? 'desc' : 'asc'}, usertype=${usertype}, showFirmAdmins=${showFirmAdmins})} + '\''">
                            Email
                            <img th:if="${sort == 'email' and direction == 'asc'}"
                                 th:src="@{/assets/images/sort-asc.svg}"
                                 width="22" height="22" alt="">
                            <img th:if="${sort == 'email' and direction == 'desc'}"
                                 th:src="@{/assets/images/sort-desc.svg}"
                                 width="22" height="22" alt="">
                            <img th:if="${sort != 'email'}"
                                 th:src="@{/assets/images/sort-none.svg}"
                                 width="22" height="22" alt="">
                        </button>
                    </th>
                    <th scope="col" class="govuk-table__header"
                        th:aria-sort="${sort == 'userType' ? direction : 'none'}" style="width: 15%; min-width: 110px;">
                        <button type="button" data-index="3"
                                th:onclick="'window.location.href=\'' + @{/admin/users(size=${requestedPageSize ?: 10}, page=${page ?: 1}, search=${search}, sort='userType', direction=${sort == 'userType' and direction == 'asc' ? 'desc' : 'asc'}, usertype=${usertype}, showFirmAdmins=${showFirmAdmins})} + '\''">
                            User Type
                            <img th:if="${sort == 'userType' and direction == 'asc'}"
                                 th:src="@{/assets/images/sort-asc.svg}"
                                 width="22" height="22" alt="">
                            <img th:if="${sort == 'userType' and direction == 'desc'}"
                                 th:src="@{/assets/images/sort-desc.svg}"
                                 width="22" height="22" alt="">
                            <img th:if="${sort != 'userType'}"
                                 th:src="@{/assets/images/sort-none.svg}"
                                 width="22" height="22" alt="">
                        </button>
                    </th>
                    <th scope="col" class="govuk-table__header"
                        th:aria-sort="${sort == 'userStatus' ? direction : 'none'}" style="width: 10%; min-width: 90px;">
                        <button type="button" data-index="4"
                                th:onclick="'window.location.href=\'' + @{/admin/users(size=${requestedPageSize ?: 10}, page=${page ?: 1}, search=${search}, sort='userStatus', direction=${sort == 'userStatus' and direction == 'asc' ? 'desc' : 'asc'}, usertype=${usertype}, showFirmAdmins=${showFirmAdmins})} + '\''">
                            Status
                            <img th:if="${sort == 'userStatus' and direction == 'asc'}"
                                 th:src="@{/assets/images/sort-asc.svg}"
                                 width="22" height="22" alt="">
                            <img th:if="${sort == 'userStatus' and direction == 'desc'}"
                                 th:src="@{/assets/images/sort-desc.svg}"
                                 width="22" height="22" alt="">
                            <img th:if="${sort != 'userStatus'}"
                                 th:src="@{/assets/images/sort-none.svg}"
                                 width="22" height="22" alt="">
                        </button>
                    </th>
                </tr>
                </thead>

                <tbody class="govuk-table__body">
                <tr class="govuk-table__row" th:each="user : ${users}">
                    <td class="govuk-table__cell" style="word-wrap: break-word; overflow-wrap: break-word;">
                        <a class="govuk-link" th:href="@{/admin/users/manage/{id}(id=${user.id})}"
                           th:text="${user.fullName}"></a>
                    </td>
                    <td class="govuk-table__cell" style="word-wrap: break-word; overflow-wrap: break-word;"
                        th:text="${user.firm != null ? user.firm.name : ''}"></td>
                    <td class="govuk-table__cell" style="word-wrap: break-word; overflow-wrap: break-word;"
                        th:text="${user.entraUser.email}"></td>
                    <td class="govuk-table__cell" style="word-wrap: break-word; overflow-wrap: break-word;">
                                        <span th:switch="${#strings.trim(user.userType)}">
                                            <span th:case="'INTERNAL'">Internal</span>
                                            <span th:case="'EXTERNAL_SINGLE_FIRM_ADMIN'">Firm Admin</span>
                                            <span th:case="'EXTERNAL_SINGLE_FIRM'">Firm User</span>
                                            <span th:case="'EXTERNAL_MULTI_FIRM'">Multi Firm User</span>
                                            <span th:case="*" th:text="${user.userType}"></span>
                                        </span>
                    </td>
                    <td class="govuk-table__cell">
                                        <span th:if="${user.userProfileStatus?.getValue() == 'PENDING'}"
                                              class="moj-badge moj-badge--red">PENDING</span>
                        <span th:if="${user.userProfileStatus?.getValue() == 'COMPLETE'}"
                              class="moj-badge moj-badge--green">COMPLETE</span>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </form>
    <nav class="govuk-pagination" aria-label="Pagination">
        <div class="govuk-pagination__prev" th:if="${page > 1}">
            <a class="govuk-link govuk-pagination__link"
               th:href="@{/admin/users(size=${requestedPageSize}, page=${page - 1}, search=${search}, sort=${sort}, direction=${direction}, usertype=${usertype}, showFirmAdmins=${showFirmAdmins})}"
               rel="prev">
                <svg class="govuk-pagination__icon govuk-pagination__icon--prev" xmlns="http://www.w3.org/2000/svg" height="13" width="15" aria-hidden="true" focusable="false" viewBox="0 0 15 13">
                    <path d="m6.5938-0.0078125-6.7266 6.7266 6.7441 6.4062 1.377-1.449-4.1856-3.9768h12.896v-2h-12.984l4.2931-4.293-1.414-1.414z"></path>
                </svg>
                <span class="govuk-pagination__link-title">
                                Previous<span class="govuk-visually-hidden"> page</span>
                            </span>
            </a>
        </div>

        <ul class="govuk-pagination__list">
            <!-- First page -->
            <li class="govuk-pagination__item" th:if="${totalPages > 0}"
                th:classappend="${page == 1 ? 'govuk-pagination__item--current' : ''}">
                <a class="govuk-link govuk-pagination__link" th:if="${page != 1}"
                   th:href="@{/admin/users(size=${requestedPageSize}, page=1, search=${search}, sort=${search}, direction=${direction}, usertype=${usertype}, showFirmAdmins=${showFirmAdmins})}"
                   th:aria-label="'Page 1'">1</a>
                <a class="govuk-link govuk-pagination__link" th:if="${page == 1}"
                   th:href="@{/admin/users(size=${requestedPageSize}, page=1, search=${search}, sort=${sort}, direction=${direction}, usertype=${usertype}, showFirmAdmins=${showFirmAdmins})}"
                   th:aria-label="'Page 1'" aria-current="page">1</a>
            </li>

            <!-- Left ellipses if needed -->
            <li class="govuk-pagination__item govuk-pagination__item--ellipses" th:if="${page > 4}">
                &ctdot;
            </li>

            <!-- Pages around current page -->
            <th:block th:each="i : ${#numbers.sequence(T(java.lang.Math).max(2, page - 2), T(java.lang.Math).min(totalPages - 1, page + 2))}">
                <li class="govuk-pagination__item" th:if="${i > 1 and i < totalPages}"
                    th:classappend="${i == page ? 'govuk-pagination__item--current' : ''}">
                    <a class="govuk-link govuk-pagination__link" th:if="${i != page}"
                       th:href="@{/admin/users(size=${requestedPageSize}, page=${i}, search=${search}, sort=${sort}, direction=${direction}, usertype=${usertype}, showFirmAdmins=${showFirmAdmins})}"
                       th:aria-label="'Page ' + ${i}" th:text="${i}"></a>
                    <a class="govuk-link govuk-pagination__link" th:if="${i == page}"
                       th:href="@{/admin/users(size=${requestedPageSize}, page=${i}, search=${search}, sort=${sort}, direction=${direction}, usertype=${usertype}, showFirmAdmins=${showFirmAdmins})}"
                       th:aria-label="'Page ' + ${i}" aria-current="page" th:text="${i}"></a>
                </li>
            </th:block>

            <!-- Right ellipses if needed -->
            <li class="govuk-pagination__item govuk-pagination__item--ellipses" th:if="${page < totalPages - 3}">
                &ctdot;
            </li>

            <!-- Last page -->
            <li class="govuk-pagination__item" th:if="${totalPages > 1}"
                th:classappend="${page == totalPages ? 'govuk-pagination__item--current' : ''}">
                <a class="govuk-link govuk-pagination__link" th:if="${page != totalPages}"
                   th:href="@{/admin/users(size=${requestedPageSize}, page=${totalPages}, search=${search}, sort=${sort}, direction=${direction}, usertype=${usertype}, showFirmAdmins=${showFirmAdmins})}"
                   th:aria-label="'Page ' + ${totalPages}" th:text="${totalPages}"></a>
                <a class="govuk-link govuk-pagination__link" th:if="${page == totalPages}"
                   th:href="@{/admin/users(size=${requestedPageSize}, page=${totalPages}, search=${search}, sort=${sort}, direction=${direction}, usertype=${usertype}, showFirmAdmins=${showFirmAdmins})}"
                   th:aria-label="'Page ' + ${totalPages}" aria-current="page" th:text="${totalPages}"></a>
            </li>
        </ul>

        <div class="govuk-pagination__next" th:if="${page < totalPages}">
            <a class="govuk-link govuk-pagination__link"
               th:href="@{/admin/users(size=${requestedPageSize}, page=${page + 1}, search=${search}, sort=${sort}, direction=${direction}, usertype=${usertype}, showFirmAdmins=${showFirmAdmins})}"
               rel="next">
                            <span class="govuk-pagination__link-title">
                                Next<span class="govuk-visually-hidden"> page</span>
                            </span>
                <svg class="govuk-pagination__icon govuk-pagination__icon--next" xmlns="http://www.w3.org/2000/svg" height="13" width="15" aria-hidden="true" focusable="false" viewBox="0 0 15 13">
                    <path d="m8.107-0.0078125-1.4136 1.414 4.2926 4.293h-12.986v2h12.896l-4.1855 3.9766 1.377 1.4492 6.7441-6.4062-6.7246-6.7266z"></path>
                </svg>
            </a>
        </div>
    </nav>
    <style>
        /* Prevent visited link styling on pagination */
        .govuk-pagination__link:visited {
            color: #1d70b8; /* Same as unvisited govuk-link color */
        }
        .govuk-pagination__link:visited:hover {
            color: #003078; /* Same as unvisited govuk-link hover color */
        }
        .govuk-pagination__link:visited:focus {
            color: #0b0c0c; /* Same as unvisited govuk-link focus color */
        }
    </style>
    <p class="moj-pagination__results">Showing <b
            th:text="${((requestedPageSize ?: 10) * ((page ?: 1) - 1)) + 1}"></b>
        to <b th:text="${((requestedPageSize ?: 10) * ((page ?: 1) - 1)) + (actualPageSize ?: 10)}"></b>
        of <b th:text="${totalUsers}"></b> results</p>
    <div aria-live="polite" role="status" aria-atomic="true" class="govuk-visually-hidden"></div>
    </div>
    </div>
</main>
</body>

</html>