<!DOCTYPE html>
<html lang="en" th:replace="~{layout :: layout(
      title=~{::title},
      mainContent=~{::#main-content},
      pageCategory=${'reassign-firm'},
      breadcrumbs=~{::#breadcrumbs})}" xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Reassign user to a different firm</title>
</head>

<body>
    <nav aria-label="Breadcrumb" class="govuk-breadcrumbs" id="breadcrumbs">
        <ol class="govuk-breadcrumbs__list">
            <li class="govuk-breadcrumbs__list-item">
                <a class="govuk-breadcrumbs__link" th:href="@{'/admin/users/manage/' + ${user.id}}">Back</a>
            </li>
        </ol>
    </nav>
    
    <main class="govuk-main-wrapper" id="main-content">
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
                
                <div th:if="${errorMessage}" class="govuk-error-summary" role="alert" aria-labelledby="error-summary-title" tabindex="-1" data-module="govuk-error-summary">
                    <h2 class="govuk-error-summary__title" id="error-summary-title">
                        There is a problem
                    </h2>
                    <div class="govuk-error-summary__body">
                        <ul class="govuk-list govuk-error-summary__list">
                            <li>
                                <a href="#firm-search-input" th:text="${errorMessage}"></a>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="govuk-notification-banner govuk-notification-banner--important" role="region" aria-labelledby="govuk-notification-banner-title" data-module="govuk-notification-banner">
                    <div class="govuk-notification-banner__header">
                        <h2 class="govuk-notification-banner__title" id="govuk-notification-banner-title">
                            Important
                        </h2>
                    </div>
                    <div class="govuk-notification-banner__content">
                        <p class="govuk-body">
                            <strong>Reassigning this user will remove them from their current firm and delete all roles and office access. A new profile will be created with a new system ID. This cannot be undone and may affect other services. Only use this if the firm was set in error.</strong>
                        </p>
                    </div>
                </div>

                <h1 class="govuk-heading-l">Select the user's firm</h1>

                <form method="post" th:action="@{'/admin/users/reassign-firm/' + ${user.id} + '/select-firm'}" th:object="${firmReassignmentForm}">
                    
                    <!-- Firm Search Field -->
                    <div class="govuk-form-group govuk-!-margin-bottom-6" th:classappend="${#fields.hasErrors('firmSearch')} ? 'govuk-form-group--error'">
                        <div class="govuk-hint" id="firm-search-hint">
                            Start typing a firm name or ID and select from the list of options
                        </div>
                        
                        <div th:if="${#fields.hasErrors('firmSearch')}" class="govuk-error-message" id="firm-search-error">
                            <span class="govuk-visually-hidden">Error:</span>
                            <span th:errors="*{firmSearch}"></span>
                        </div>
                        
                        <div class="autocomplete__wrapper">
                            <div class="autocomplete__status"
                                style="border: 0px; clip: rect(0px, 0px, 0px, 0px); height: 1px; margin-bottom: -1px; margin-right: -1px; overflow: hidden; padding: 0px; position: absolute; white-space: nowrap; width: 1px;">
                                <div id="firm-search-input__status--A" role="status" aria-atomic="true" aria-live="polite"></div>
                                <div id="firm-search-input__status--B" role="status" aria-atomic="true" aria-live="polite"></div>
                            </div>
                            <div class="autocomplete__input-wrapper">
                                <input aria-expanded="false" 
                                       aria-controls="firm-search-input__listbox" 
                                       aria-autocomplete="list"
                                       autocomplete="off" 
                                       class="autocomplete__input autocomplete__input--default govuk-input" 
                                       th:classappend="${#fields.hasErrors('firmSearch')} ? 'govuk-input--error' : ''"
                                       id="firm-search-input" 
                                       name="firmSearch" 
                                       placeholder="" 
                                       type="text"
                                       role="combobox"
                                       th:value="*{firmSearch}"
                                       aria-describedby="firm-search-hint"
                                       th:aria-describedby="${#fields.hasErrors('firmSearch')} ? 'firm-search-error firm-search-hint' : 'firm-search-hint'" />
                                
                                <ul aria-labelledby="firm-search-input" 
                                    id="firm-search-input__listbox" 
                                    role="listbox"
                                    class="autocomplete__menu autocomplete__menu--inline autocomplete__menu--hidden">
                                    <!-- Search results will be populated here via JavaScript -->
                                </ul>
                            </div>
                            
                            <input type="hidden" id="selected-firm-id" name="selectedFirmId" th:value="*{selectedFirmId}" />
                        </div>
                    </div>

                    <div class="govuk-button-group">
                        <button type="submit" class="govuk-button" data-module="govuk-button">
                            Continue
                        </button>
                        <a class="govuk-link" th:href="@{'/admin/users/manage/' + ${user.id}}">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
        
        <style>
            /* GDS-compliant autocomplete styles */
            .autocomplete__wrapper {
                position: relative;
            }

            .autocomplete__input-wrapper {
                position: relative;
                display: block;
                width: 100%;
                max-width: 40em;
            }

            .autocomplete__menu {
                background-color: #ffffff;
                border: 2px solid #0b0c0c;
                border-top: none;
                box-sizing: border-box;
                color: #0b0c0c;
                font-family: "GDS Transport", arial, sans-serif;
                font-size: 19px;
                font-weight: 400;
                line-height: 1.31579;
                margin: 0;
                max-height: 200px;
                overflow-y: auto;
                padding: 0;
                position: absolute;
                top: 100%;
                left: 0;
                width: 100%;
                z-index: 100;
                list-style: none;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            }

            .autocomplete__menu--hidden {
                display: none !important;
            }

            .autocomplete__menu--inline {
                display: block;
            }

            .autocomplete__option {
                background-color: #ffffff;
                border-bottom: 1px solid #b1b4b6;
                color: #0b0c0c;
                cursor: pointer;
                display: block;
                font-size: 19px;
                line-height: 1.31579;
                padding: 8px 12px;
                text-decoration: none;
                position: relative;
            }

            .autocomplete__option:last-child {
                border-bottom: none;
            }

            .autocomplete__option:hover,
            .autocomplete__option[aria-selected="true"] {
                background-color: #1d70b8;
                color: #ffffff;
            }

            .autocomplete__option:hover strong,
            .autocomplete__option[aria-selected="true"] strong {
                color: #ffffff;
            }

            .autocomplete__option:hover small,
            .autocomplete__option[aria-selected="true"] small {
                color: #ffffff !important;
            }

            .autocomplete__option strong {
                font-weight: 700;
                display: block;
                margin-bottom: 4px;
            }

            .autocomplete__option small {
                font-size: 16px;
                color: #505a5f;
                display: block;
                line-height: 1.4;
            }

            /* Make the input look consistent with GOV.UK styling */
            .autocomplete__input {
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                background-color: #ffffff;
                border: 2px solid #0b0c0c;
                border-radius: 0;
                box-sizing: border-box;
                color: #0b0c0c;
                font-family: "GDS Transport", arial, sans-serif;
                font-size: 19px;
                font-weight: 400;
                line-height: 1.31579;
                margin: 0;
                padding: 8px;
                width: 100%;
            }

            .autocomplete__input:focus {
                border-color: #0b0c0c;
                box-shadow: inset 0 0 0 2px;
                outline: 3px solid #ffdd00;
                outline-offset: 0;
            }

            .autocomplete__input:disabled {
                background-color: #f3f2f1;
                color: #505a5f;
                cursor: not-allowed;
            }

            .autocomplete__option--odd {
                background-color: #ffffff;
            }

            .autocomplete__option--odd:hover,
            .autocomplete__option--odd[aria-selected="true"] {
                background-color: #1d70b8;
                color: #ffffff;
            }
        </style>
        
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const firmSearchInput = document.getElementById('firm-search-input');
                const firmSearchListbox = document.getElementById('firm-search-input__listbox');
                const selectedFirmIdInput = document.getElementById('selected-firm-id');
                const statusA = document.getElementById('firm-search-input__status--A');
                const statusB = document.getElementById('firm-search-input__status--B');

                if (!firmSearchInput) {
                    return;
                }

                let searchTimeout;
                let selectedIndex = -1;
                let currentStatusElement = statusA;

                // Handle input changes
                firmSearchInput.addEventListener('input', function () {
                    clearTimeout(searchTimeout);
                    const query = this.value.trim();

                    if (query.length < 1) {
                        hideResults();
                        selectedFirmIdInput.value = '';
                        return;
                    }

                    searchTimeout = setTimeout(() => {
                        searchFirms(query);
                    }, 300);
                });

                // Handle keyboard navigation
                firmSearchInput.addEventListener('keydown', function (e) {
                    const items = firmSearchListbox.querySelectorAll('.autocomplete__option');

                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                        updateSelection(items);
                        updateStatus(`${selectedIndex + 1} of ${items.length}`);
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        selectedIndex = Math.max(selectedIndex - 1, -1);
                        updateSelection(items);
                        if (selectedIndex >= 0) {
                            updateStatus(`${selectedIndex + 1} of ${items.length}`);
                        }
                    } else if (e.key === 'Enter' && selectedIndex >= 0) {
                        e.preventDefault();
                        items[selectedIndex].click();
                    } else if (e.key === 'Escape') {
                        hideResults();
                    }
                });

                // Hide results when clicking outside
                document.addEventListener('click', function (e) {
                    if (!firmSearchInput.contains(e.target) && !firmSearchListbox.contains(e.target)) {
                        hideResults();
                    }
                });

                function searchFirms(query) {
                    updateStatus('Searching...');
                    fetch(`/admin/user/firms/search?q=${encodeURIComponent(query)}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        displayResults(data);
                    })
                    .catch(error => {
                        hideResults();
                        updateStatus('Search failed: ' + error.message);
                    });
                }

                function displayResults(firms) {
                    firmSearchListbox.innerHTML = '';
                    selectedIndex = -1;

                    const currentQuery = firmSearchInput.value.trim();

                    if (firms.length === 0 && currentQuery.length > 0) {
                        const noResultsItem = document.createElement('li');
                        noResultsItem.className = 'autocomplete__option';
                        noResultsItem.textContent = 'No firms found';
                        noResultsItem.setAttribute('role', 'option');
                        noResultsItem.setAttribute('aria-selected', 'false');
                        noResultsItem.style.color = '#6f777b';
                        firmSearchListbox.appendChild(noResultsItem);

                        showResults();
                        updateStatus('No results found');
                        return;
                    } else if (firms.length === 0) {
                        hideResults();
                        return;
                    }

                    firms.forEach((firm, index) => {
                        const item = document.createElement('li');
                        item.className = 'autocomplete__option';
                        item.setAttribute('aria-selected', 'false');
                        item.setAttribute('role', 'option');
                        item.setAttribute('tabindex', '-1');
                        item.setAttribute('id', `firm-search-input__option--${index}`);
                        item.setAttribute('aria-posinset', index + 1);
                        item.setAttribute('aria-setsize', firms.length);

                        const firmName = firm.name || '';
                        const firmCode = firm.code && firm.code.trim() ? firm.code : 'No code available';

                        const strongElement = document.createElement('strong');
                        strongElement.textContent = firmName;

                        const smallElement = document.createElement('small');
                        smallElement.textContent = `Firm code: ${firmCode}`;

                        item.appendChild(strongElement);
                        item.appendChild(smallElement);

                        item.addEventListener('click', function () {
                            selectFirm(firm);
                        });

                        item.addEventListener('mouseenter', function () {
                            selectedIndex = index;
                            updateSelection(firmSearchListbox.querySelectorAll('.autocomplete__option'));
                        });

                        firmSearchListbox.appendChild(item);
                    });

                    showResults();
                    updateStatus(`${firms.length} result${firms.length === 1 ? '' : 's'} available`);
                }

                function selectFirm(firm) {
                    firmSearchInput.value = firm.name;
                    selectedFirmIdInput.value = firm.id;
                    hideResults();
                    updateStatus(`${firm.name} selected`);
                }

                function updateSelection(items) {
                    items.forEach((item, index) => {
                        if (!item) return;

                        if (index === selectedIndex) {
                            item.setAttribute('aria-selected', 'true');
                            item.style.backgroundColor = '#1d70b8';
                            item.style.color = 'white';
                            item.scrollIntoView({ block: 'nearest' });
                        } else {
                            item.setAttribute('aria-selected', 'false');
                            item.style.backgroundColor = '';
                            item.style.color = '';
                        }
                    });
                }

                function showResults() {
                    firmSearchListbox.classList.remove('autocomplete__menu--hidden');
                    firmSearchListbox.classList.add('autocomplete__menu--inline');
                    firmSearchInput.setAttribute('aria-expanded', 'true');
                }

                function hideResults() {
                    firmSearchListbox.classList.add('autocomplete__menu--hidden');
                    firmSearchListbox.classList.remove('autocomplete__menu--inline');
                    firmSearchInput.setAttribute('aria-expanded', 'false');
                    selectedIndex = -1;
                }

                function updateStatus(message) {
                    currentStatusElement = currentStatusElement === statusA ? statusB : statusA;
                    currentStatusElement.textContent = message;
                }
            });
        </script>
    </main>
</body>

</html>
